<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Edit Profile Form</title>
<script type="text/javascript" src="../js/jquery-1.7.min.js"></script>
<script src="../js/exif.js"></script>
<script type="text/javascript">
	var UserId = null;
	var FullName = null;
	var Mobile = null;
	var Location = null;
    var Address = '';
    var Sublocality = '';
    var Locality = '';
    var Lat = 0.0;
    var Lng = 0.0;
	var image_url =null;
	var AccessToken = null;

	editProfileReq = function() {
		UserId = document.getElementById("userId").value;
		FullName = document.getElementById("fullName").value;
		Mobile = document.getElementById("mobile").value;
        AccessToken = document.getElementById("accessToken").value;
        
        editProfileData();
	};
	
	//beginning of image display
	$(document).ready(function() {
	canvasCtx = document.getElementById("panel").getContext("2d");
	
	document.getElementById("ifile").onchange = function(event) {
		
		EXIF.getData(event.target.files[0], function() {
		exif = EXIF.getAllTags(this);
	
		picOrientation = exif.Orientation;
		});
		
		this.imageFile = event.target.files[0];
		
		var reader = new FileReader();
		reader.onload =  function(event) {
			var img = new Image();
			
			img.onload = function() {
				drawImage(img);
			}
			img.src = event.target.result;
			
		}
		reader.readAsDataURL(this.imageFile);	
	}
		
	drawImage = function(img) {
		this.canvasCtx.canvas.width = 300;//img.width;
		this.canvasCtx.canvas.height = 300;//img.height;
		
		if(img.width>img.height){                      							//Landscape Image 
			canvasCtx.width = 300;
			canvasCtx.height = 300 / img.width * img.height;
		} else {                                                                  //Portrait Image
			canvasCtx.width = 300 / img.height * img.width;
			canvasCtx.height = 300;
		} 
		
		if (picOrientation==2){
			this.canvasCtx.transform(-1, 0, 0, 1,canvasCtx.width, 0);
		}
		if (picOrientation==3){
			this.canvasCtx.transform(-1, 0, 0, -1,canvasCtx.width, canvasCtx.height);
		}
		if (picOrientation==4){
			this.canvasCtx.transform(1, 0, 0, -1, 0, canvasCtx.height );
		}
		if (picOrientation==5){
			this.canvasCtx.transform(0, 1, 1, 0, 0, 0);
		}
		if (picOrientation==6){
			this.canvasCtx.transform(0, 1, -1, 0, canvasCtx.height , 0);
		}
		if (picOrientation==7){
			this.canvasCtx.transform(0, -1, -1, 0, canvasCtx.height , canvasCtx.width);
		}
		if (picOrientation==8){
			this.canvasCtx.transform(0, -1, 1, 0, 0, canvasCtx.width);
		}
		
		this.canvasCtx.drawImage(img,0,0,canvasCtx.width, canvasCtx.height);
		image_url = canvasCtx.canvas.toDataURL();
	}			
	//end of image display
    });
	
    verifyAddress = function(){
        Address = '';
        Sublocality = '';
        Locality = '';
        Lat = 0.0;
        Lng = 0.0;
        
		Location = document.getElementById("location").value;
        
        if(Location != '')
            getLocationData(Location);
    }
    
    getLocationData = function(location){
        alert("getting location data");
        $.ajax({
            url: 'https://maps.googleapis.com/maps/api/geocode/json',
            type: 'get',
            data: 'address='+location+"&key=AIzaSyAmvX5_FU3TIzFpzPYtwA6yfzSFiFlD_5g",
            success: function(response){
                if(response.status == 'OK'){
                    Address = response.results[0].formatted_address;
                    response.results[0].address_components.forEach(function(component){
                        if(component.types[0] == 'sublocality_level_1')
                            Sublocality = component.long_name;
                        if(component.types[0] == 'locality')
                            Locality = component.long_name;
                    });
                    Lat = response.results[0].geometry.location.lat;
                    Lng = response.results[0].geometry.location.lng;
                    
                    // updating the text boxes
                    document.getElementById("lat").value = Lat;
                    document.getElementById("lng").value = Lng;
                    document.getElementById("address").value = Address;
                    document.getElementById("sublocality").value = Sublocality;
                    document.getElementById("locality").value = Locality;
                }
            },
            error: function(){
                alert("not able to get location data");
            }
        });
    }
    
    editProfileData = function(){
        var req = {
			userId : UserId,
			fullName : FullName,
			mobile : Mobile,
			location : Location,
            address: Address,
            locality: Locality,
            sublocality: Sublocality,
            lat: Lat,
            lng: Lng,
			photoId: image_url,
            accessToken: AccessToken
		}
		editProfileSend(req);
    }

	editProfileSend = function(req) {
		$
				.ajax({
					url : '/flsv2/EditProfile',
					type : 'post',
					data : JSON.stringify(req),
					contentType : "application/json",
					dataType : "json",

					success : function(response) {
						document.getElementById("code").value = response.code;
						document.getElementById("userId").value = "";
						document.getElementById("fullName").value = "";
						document.getElementById("mobile").value = "";
						document.getElementById("location").value = "";
						if (response.code == 0) {
							document.getElementById("message").value = "";
						} else {
							document.getElementById("message").value = response.message;
						}
					},

					error : function() {
						alert("not working");
					}
				});
	};
</script>
</head>
<body>
	<h1>EDIT PROFILE FORM</h1>
	<form>
		User Id : <input type="text" name="userId" id="userId"><br />
		<br /> Full Name : <input type="text" name="fullName" id="fullName"><br />
		<br /> Access Token: <input type="text" name="accessToken" id="accessToken" ><br/>
		<br /> Mobile : <input type="text" name="mobile" id="mobile"><br />
		<br /> Location : <input type="text" name="location" id="location"><br />
		<br /> Latitude : <input type="text" name="latitude" id="lat"><br />
		<br /> Longitude : <input type="text" name="longitude" id="lng"><br />
		<br /> Address : <input type="text" name="address" id="address"><br />
		<br /> Locality : <input type="text" name="locality" id="locality"><br />
		<br /> Sublocality : <input type="text" name="sublocality" id="sublocality"><br />
		<br /> Add Id Proof : <input type="file" name="file" id="ifile"><br />
        <br > <canvas id="panel" width="300" height="300" style=" display: table;margin: 0 auto;margin-bottom:10px;margin-left:0px;"></canvas>
		<input type="button" value="Edit Profile" onclick="editProfileReq()"><br /> <br />

		<h1>OUTPUT</h1>
		Code : <input type="text" name="code" id="code"><br /> <br />
		Message : <input type="text" name="message" id="message"><br />
		<br />
	</form>

	<br />
	<h3>
		<A href="index.html">INDEX</A>
	</h3>
</body>
</html>