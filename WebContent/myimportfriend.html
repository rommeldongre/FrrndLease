<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="909447696017-ka0dc75ts261cua6d2ho5mvb7uuo9njc.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>    
	<script src="https://apis.google.com/js/client.js"></script>
	<script src="js/Facebook_api.js"></script>
	
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Import Friends</title>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery-1.11.3.min.js"></script>
	
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/myfriend.css" rel="stylesheet">
	<link href="css/mystore.css" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Happy+Monkey' rel='stylesheet' type='text/css'>
	
	<!--Loading Animation code CSS & JS Links  -->
	<link href="css/animation.css" type="text/css" rel="stylesheet">
	<script src="js/jquery.backstretch.js"></script>
	<script src="js/animation.js"></script>
	<!--Loading Animation code CSS & JS Links ends here  -->
	
	<!-- DropDown list code-->
    <script src="js/dropdownlist.js"></script>
    <!-- DropDown list code ends-->
	
	<!--Check whether user is logged in or not  -->
	<script src="js/logincheck.js"></script>
	<!--Check whether user is logged in or not ends here  -->
	
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  
  <body onload="start()">
  <div id="loader">
</div>
	<div id="main">	
		
		<nav class="navbar navbar-default navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar1">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>                        
					</button>
					<a href="index.html" class="navbar-brand" id="icon"><b>frrndLease</b></a>
				</div>
				<div class="collapse navbar-collapse" id="myNavbar1">
					
					<ul class="nav navbar-nav navbar-right" id="navbar1right">
						<li class="dropdown" id="subheader">
							<a class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
							<span id="salutation"></span> <span class="caret"></span></a>
							<ul class="dropdown-menu" id="dropA">
								<!-- Dynamic Binding for the Drop Down List. Refer file dropdownlist.js-->
							</ul>
						</li>
					</ul>
					
					<form class="navbar-form navbar-right" role="search" id="navBarSearchForm" type=get action="myindex.html">
					<!-- Search Bar is displayed here. Refer file dropdownlist.js-->
					</form>
					
					<div class="navbar-form navbar-right">
						<button onclick="storeYourStuff()" id="button_top_right" class="btn btn-primary">StoreYourStuff</button>
					</div>
					
				</div>
			</div>
		</nav>
		
		<div class="container-fluid" id="midcontainer">
		<div id="heading"><strong>Invite Friends</strong></div><br/>
			<div class="row">
				<div class="col-*-12">
					<center><button class="btn btn-primary" id="importfb" onclick="importfb()">Invite Facebook Friends</button>
					</center>
				</div>
			</div>
			</br> </br>
			<div class="row">
				<div class="col-*-12">
					<center><button class="btn btn-primary" id="importgoogle" onclick="importgoogle()">Invite Gmail Friends</button>
					</center>
				</div>
			</div>
			</br> </br>
			<div class="row">
				<div class="col-*-12">
					<center><button class="btn btn-primary" id="importwhatsapp" onclick="importwhatsapp()">Invite Whatsapp Friends</button>
					</center>
				</div> 
			</div>
			</br> <br />

			<div id="emailbox" class="input-group">
				<input type="text" id="importemail" class="form-control" placeholder=" Email, comma separated. example1@xyz.com, example2@abc.net">
				<span class="input-group-btn">
					<button class="btn btn-primary" onclick="directImport()">Invite Friends by Email</button>
				</span>
			</div>			
			<br /><br />
			
			<!-- sample pop up starts here-->
			<button href="#myModalTable" id="openBtn" data-toggle="modal" class="btn btn-default">Modal</button>

			<div class="modal fade" id="myModalTable">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
					<h3 class="modal-title">Import Google Contacts</h3>
					</div>
					<div class="modal-body">
					<h5 class="text-center">Please Select the Google Contacts you want to Import</h5>
					<table id="friendsoptionstable" class="table table-striped" style='table-layout:fixed;word-wrap:break-word;'>
						<thead>
							<tr>
								<!--<th class="tablecell"  style='word-wrap: break-word'>Email</th>-->
								<th class="tablecell" style="width: 50%">Email</th>
								<th class="tablecell" style="width: 15%">Name</th>
								<th class="tablecell" style="width: 25%">Mobile</th>
								<th class="tablecell" style="width: 12%">Import</th>
							</tr>
						</thead>
						<tbody>
							
						</tbody>
					</table>
					<!--<div class="form-group">
						<input type="button" class="btn btn-warning btn-sm pull-right" value="Reset">
						<div class="clearfix"></div>
					</div>-->
					</div>
					<div class="modal-footer">
					<button type="button" class="btn btn-default " data-dismiss="modal" onclick="redirectToPrevPage()">Cancel</button>
					<button class="btn btn-primary" id="addcheckedfriends1" onclick="add_checked_friends()">Save Selected Friends</button>
					<!--<button type="button" class="btn btn-success" onclick="add_checked_friends() >Import Contacts</button>-->
					</div>
							
				</div><!-- /.modal-content -->
				</div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
			<!-- sample pop up ends here-->
			
			<!--for friends imported from google-->
			<!--<table id="friendsoptionstable" class="table table-striped">
				<thead>
					<tr>
						<th class="tablecell">Email</th>
						<th class="tablecell">Name</th>
						<th class="tablecell">Mobile</th>
						<th class="tablecell">Import</th>
					</tr>
				</thead>
				<tbody>
					
				</tbody>
			</table>-->
			<br />
			<div class="row">
				<div class="col-md-5 col-lg-5 col-sm-5 col-xs-5"></div>
				<div class="col-md-5 col-lg-5 col-sm-5 col-xs-5">
					<button class="btn btn-primary" id="addcheckedfriends" onclick="add_checked_friends()">Save Selected Friends</button>
				</div>
				<div class="col-md-2 col-lg-2 col-sm-2 col-xs-2"></div>
			</div>
			<br />
			<br />
			<br />
			<!-- Button trigger Alert Modal -->
			<button id="alertModalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myAlertModal" data-backdrop="static" data-keyboard="false">
			  Launch demo modal
			</button>

			<!-- Alert Modal -->
			<div class="modal fade" id="myAlertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			  <div class="modal-dialog" role="document">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<!--<h4 class="modal-title" id="myModalLabel">Modal title</h4>-->
				  </div>
				  <div class="modal-body" id="alertModalMsg">
					
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" onclick="continueWork()">Yes</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
				  </div>
				</div>
			  </div>
			</div>
			
			<!-- Button trigger Confirmation Modal -->
			<button id="modalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal" data-backdrop="static" data-keyboard="false">
			  Launch demo modal
			</button>

			<!-- Confirmation Modal -->
			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			  <div class="modal-dialog" role="document">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel"></h4>
				  </div>
				  <div class="modal-body" id="modalMsg">
					
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirectToPrevPage()">Close</button>
				  </div>
				</div>
			  </div>
			</div>
			
			<!-- "Please Wait" Modal Start here-->
			<div id="wait_bar">
			</div>
			<!-- "Please Wait" Modal ends Here -->
			
			<div id="tawk_widget">
				<!--The tawk.to widget code will get populated here-->
			</div>
			
			<div id="footer_nav">
				<!--The Footer nav will get populated here-->
			</div>
		
		</div>
	</div>
		
	<script type="text/javascript">
		var googleFriendsCounter = 0, counter = 0, checkcounter = 0, email = '', name = '', number = '', user_email = '', len = 0, directFriendCounter = 1, i = 0, emailFlag1 = 0, emailFlag2 = 0;
		
		var clientId = '349857239428-jtd6tn19skoc9ltdr6tsrbsbecv5uhh3.apps.googleusercontent.com';
		var apiKey = 'API Code';
		var scopes = 'https://www.googleapis.com/auth/contacts.readonly';
	
		function start(){
			$("#modalTriggerButton").hide();
			$("#alertModalTriggerButton").hide();
			$("#addcheckedfriends").hide();
			$("#openBtn").hide();
			setPrevPage("myimportfriend.html");
			load_Gapi();
			
			// I am using localStorage here in this file instead of the model file because multiple users will need to be logged in simultaneously at different devices
			userloggedin = localStorage.getItem("userloggedin");
			
			logInCheck();
			
			look_good();
		}
		
		function load_Gapi(){						//for google
			gapi.load('auth2', function() {
				gapi.auth2.init();
			});
		}
		
		$("#logoutoptionmenu").click(function(){					//when user logs out  
			localStorage.setItem("userloggedin", "anonymous");			//userloggedin-> anonymous
			signOutFromGoogle();
			
			redirectToHomePage()
		});
		
		function signOutFromGoogle() {					//signout from google
			var auth2 = gapi.auth2.getAuthInstance();
			auth2.signOut().then(function () {
				console.log('User signed out.');
			});
		}
		
		function importfb(){
			
			FB.login(function(response) {
				// handle the response
				
				// check whether user is logged in or not and ask for credentials if not.
				/*
				FB.api('/me?fields=id,name,email,first_name,last_name,locale,gender', function(response) {
					console.log('Successful login for: ' + response.name+" "+response.id+" "+response.email);
					loginpassword = response.id;
					loginemail =  response.email;
				});
				*/
				// send message to facebook friends using send request dialog
				FB.ui({
					method: 'send',
					link: 'http://www.frrndlease.com/flsv2/mysignup.html',
				},function(response){
					if (response && !response.error) {
						//check 'response' to see if call was successful
						confirmationIndex("Success","Message to Facebook Friend(s) sent");
						}
				});
            }, {scope: 'email,public_profile,user_friends'});
		}
		
		function importwhatsapp(){
			
			confirmationIndex("Not Currently Supported");
		}
		
		function importgoogle(){
			//confirmationIndex("importgoogle called");
			//gapi.client.setApiKey(apiKey);
            window.setTimeout(authorize);		//calls authorize()
			$("#openBtn").click();
		}
		
		function authorize() {
			gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthorization);		//calls handleAuthorization()
        }
		
        function handleAuthorization(authorizationResult) {
            if (authorizationResult && !authorizationResult.error) {
				$.get("https://www.google.com/m8/feeds/contacts/default/thin?alt=json&access_token=" + authorizationResult.access_token + "&max-results=500&v=3.0",
				function(response){
					console.log(response);
					//function for length of entry array  (for number of contacts)
					var getLength = function(obj) {
						var i = 0, key;
						for (key in obj) {
							if (obj.hasOwnProperty(key)){
								i++;
							}
						}
						return i;
					};
					var n = getLength(response.feed.entry);
					var tp;
					
					googleFriendsCounter = n;
					
					for(i=0;i<n;i++){
					    if(response.feed.entry[i].gd$email){
						tp = i+1;
						
						user_email = JSON.stringify(response.feed.author[0].email.$t);
						user_email = user_email.substring(1,user_email.length-1);
						
						try{
							number = JSON.stringify(response.feed.entry[i].gd$phoneNumber[0].$t);
							number = number.substring(1,number.length-1);
						}catch(Exception){
							//number = "Number do not Exist for Friend " + tp;
							number = "-";
						}
						try{
							name = JSON.stringify(response.feed.entry[i].gd$name.gd$fullName.$t);
							name =  name.substring(1,name.length-1);
						}catch (Exception){ 
							//name = "Name do not Exist for Friend " +  tp;	 	
							name = "-";
						}
						try{
							email =  JSON.stringify(response.feed.entry[i].gd$email[0].address);
							email = email.substring(1,email.length-1);
						}catch(Exception){
							//email = "Email do not Exist for Friend " +  tp;	
							email = "-";
						}
					 
						addFriendOptionToPage(email,name,number,user_email,i); 
						}
					}
					
				});
			}
		}

		function addFriendOptionToPage(email,name,number,user_email,i){
			var table = document.getElementById("friendsoptionstable");
				var row = table.insertRow(1);
				var cell0 = row.insertCell(0);
				var cell1 = row.insertCell(1);
				var cell2 = row.insertCell(2);
				var cell3 = row.insertCell(3);
				
				var inputgp = document.createElement("div");
				var checkbox = document.createElement("input");
				inputgp.className = "input-group";
				checkbox.setAttribute("type","checkbox");
				inputgp.appendChild(checkbox);
				checkbox.id = i;
				
				cell0.innerHTML = email;
				cell1.innerHTML = name;
				cell2.innerHTML = number;
				cell3.appendChild(inputgp);
				
				cell0.id = "email"+i;
				cell1.id = "name"+i;
				cell2.id = "mobile"+i;
				
				cell0.className = "tablecellName";
				cell1.className = "tablecellMobile";
				cell2.className = "tablecellEmail";
				cell3.className = "checkboxes";
		}
		
		function directImport(){
			email = '';
			reasonForAddFriend = "importEmail"
		
			var value = $("#importemail").val();
			var arrEmail = [];
			var errCount = 0;
			arrEmail = value.split(",");
			len = arrEmail.length;
			if(value != '' && value != ' '){
				if(len<=20){
					for(;i<len;i++){
						var isValid = checkEmailValidity(arrEmail[i]);
						if(checkEmailValidity(arrEmail[i])){
								addFriendSetValues('-', '-', arrEmail[i], userloggedin);
								addFriendDbCreate();
							}else{
								errCount = errCount+1;
							}
						
					}
					if(errCount!=0){
						setPrevPage("myimportfriend.html");
						var validEmail = len-errCount;
						confirmationIndex("Success", "Number of email(s) imported: "+validEmail+" ,Number of Invalid email(s): "+errCount);	
					}
				}else{
					setPrevPage("myimportfriend.html");
					confirmationIndex("Sorry", "Please enter emails less than or equal to 20");
				}
			}	
		}
		
		function directImportContinued(heading, msg){
			if(i == len){
				confirmationIndex(heading, msg);
			}else{
				directImport();
			}
		}
		
		function checkEmailValidity(email){
		
			var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
			return re.test(email);
		}
		
		function add_checked_friends(){
			//alert("noOfUsers: "+googleFriendsCounter);
			//$("#myModalTable").hide();
			$('#myModalTable').modal('hide');
			if(counter==0){
			process_dialog("Adding Gmail friends Please Wait");
			}
			reasonForAddFriend = "importGoogle";
			if(counter<googleFriendsCounter){
				var ischecked = $("#"+counter).is(":checked");
				console.log(counter+": "+ischecked);
				
				if(ischecked){
					name = $("#name"+counter).text();
					mobile = $("#mobile"+counter).text();
					email = $("#email"+counter).text();
					console.log("name: "+name+" mobile: "+mobile+" email: "+email);
					checkcounter++;
					
					addFriendSetValues(name, mobile, email, userloggedin);
					addFriendDbCreate();
				}else{
					add_checked_friends_continued();		//basically just increment and call the same function again
				}
			}else{
				$("#myPleaseWait").hide();
				confirmationIndex("Successful", " Number of Friends Imported : "+checkcounter);
			}
		}
		
		function add_checked_friends_continued(){
			counter++;
			add_checked_friends();
		}
		
		
		
		function confirmationIndex(heading, msg){			//called from script_admin_v2.js
			var header = document.getElementById("myModalLabel");
			header.innerHTML = heading;
			var div = document.getElementById("modalMsg");
			div.innerHTML = msg;
			
			$("#modalTriggerButton").click();
		}
		
		function storeYourStuff(){
			storeCurrentFunction('storeYourStuff');
			setPrevPage("myimportfriend.html");
			
			window.location.replace("mystore.html");
		}
		
		function redirectToHomePage(){
			window.location.replace("index.html");
		}

		function redirectToPrevPage(){
			prevPage = getPrevPage("prevPage");
			window.location.replace(prevPage);
		}		
		
		function look_good(){
			var fbwidth = $('#importfb').width();
			$('#importwhatsapp').width(fbwidth);
			$('#importgoogle').width(fbwidth);
		}
	</script>	
		
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/index.js"></script>
	<script src="js/mystore.js"></script>
	<script src="js/script_admin_v2.js"></script>	
    <script src="js/bootstrap.min.js"></script>

  </body>
</html>