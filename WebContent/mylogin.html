<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="1074096639539-cect2rfj254j3q1i5fo7lmbfhm93jg34.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js"></script>   
	<script src="js/md5.js"></script>
	<script src="js/Facebook_api.js"></script>                                                      <!--for Facebook signin-->
	
	<title>Login Page</title>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery-1.11.3.min.js"></script>
    
	<!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="css/gsdk.css" rel="stylesheet" />
	<link href="css/myindex.css" rel="stylesheet">
	<link href="css/login.css" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Happy+Monkey' rel='stylesheet' type='text/css'>
	<link href="css/bootstrap-social.css" rel="stylesheet">
	<link href="css/font-awesome.css" rel="stylesheet">
	
	<!--Loading Animation code CSS & JS Links  -->
    <link href="css/animation.css" type="text/css" rel="stylesheet">
    <script src="js/jquery.backstretch.js"></script>
	<script src="js/animation.js"></script>
	<!--Loading Animation code CSS & JS Links ends here  -->
      
    <script src="js/bootstrap-datepicker.js"></script>
	<script src="js/bootstrap-select.js"></script>
	<script src="js/get-shit-done.js"></script>
	<script src="js/gsdk-bootstrapswitch.js"></script>
	<script src="js/gsdk-checkbox.js"></script>
	<script src="js/gsdk-morphing.js"></script>
	<script src="js/gsdk-radio.js"></script>
	<script src="js/jquery.flexisel.js"></script>
	<script src="js/jquery.tagsinput.js"></script>
	<script src="js/jquery-ui.custom.min.js"></script>
	<script src="js/retina.min.js"></script>
  </head>
  
  <body onload="start()">
  <div id="loader">
	</div>
	<div id="main">	
		
		<nav class="navbar navbar-default" id="header">
			<div class="container-fluid">
				<div class="navbar-header">
					<a href="index.html" class="navbar-brand" id="icon"><b>frrndLease</b></a>
				</div>
			</div>
		</nav>
		
		<div class="container">
			
			<div class ="google">
                <div style="float:left;" class="g-signin2" data-onsuccess="onSignIn"></div>	                 <!--Google login button-->
			</div>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			
		    <!--FB signup button-->
			<div class="facebook" style="float:left;padding-left: 20px">
                <a class="btn btn-block btn-social btn-facebook" onclick="facebookSignIn();" style="width:220px;;height: 37px">
                <span class="fa fa-facebook"></span> Connect with Facebook
                </a>
			</div>
			
            <!--Form starts here-->
            <form class="form-signin" id="loginform">
				<div id="heading" class="form-signin-heading"><strong>Please Log in</strong></div><br/>
				
				<input type="email" id="email" class="form-control" placeholder="Email address" required autofocus><br />
				<input type="password" id="password" class="form-control" placeholder="Password" required><br />
				
				<span id="newuser">
				    New User? <a href="mysignup.html" id="signup">Signup</a>
				</span>
				<br /><br />
				<button class="btn btn-lg btn-primary btn-fill btn-block" type="submit">Log in</button>
			</form>
			<br />
			<!--Form ends here-->
            
			<!--Displaying error of the form-->
			<div id="error_row">
				<div class="col-md-12 col-sm-12 col-xs-12">
					<div class="alert alert-danger fade in" id="errormsg">
						<a href="#" class="close" data-dismiss="alert">&times;</a>
						<strong>Error!</strong> 
					</div>
				</div>
			</div>	
		</div>
		
		<!-- Button trigger Alert Modal -->
		<button id="alertModalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myAlertModal" data-backdrop="static" data-keyboard="false">
		  Launch demo modal
		</button>

		<!-- Alert Modal -->
		<div class="modal fade" id="myAlertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				
			  </div>
			  <div class="modal-body" id="alertModalMsg">
				
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="continueWork()">Yes</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
			  </div>
			</div>
		  </div>
		</div>
		
		<!-- Button trigger Confirmation Modal -->
		<button id="modalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal" data-backdrop="static" data-keyboard="false">
		  Launch demo modal
		</button>

		<!-- Confirmation Modal -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">
				
				</h4>
			  </div>
			  <div class="modal-body" id="modalMsg">
				
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirectToPrevPage()">Close</button>
			  </div>
			</div>
		  </div>
		</div>
	
		<!--The tawk.to widget code will get populated here from file chatbox.html.-->
        <div id="tawk_widget"></div>
		
		<!--Footer starts------------------------------------>
			<nav class="navbar navbar-default navbar-fixed-bottom">
				<div class="container-fluid">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbarBottom">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>                        
					</button>
					<div class="collapse navbar-collapse" id="myNavbarBottom">
						<ul class="nav navbar-nav navbar-center">
							<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-th-large"></span> About</a></li>
							<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-pencil"></span> Blog</a></li>
							<li><a href="myhowitworks.html"><span class="glyphicon glyphicon-road"></span> How It Works</a></li>
							<li><a href="mycredits.html"><span class="glyphicon glyphicon-certificate"></span> Credits</a></li>
							<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-earphone"></span> Contact</a></li>
							<li><a href="https://www.surveymonkey.com/r/Y9GSGLJ" target="_blank"><span class="glyphicon glyphicon-comment"></span><b style="color:blue;"> Survey</b></a></li>
						</ul>
					</div>
				</div>
			</nav>
        <!--Footer ends--------------------------------------->
		
	</div>
	
	
	<script type="text/javascript">
		var loginemail, loginpassword, reasonforLogIn= '', friends;
		var signupstatus='';
		var loginerrormsg;
		
		function start(){
			$("#modalTriggerButton").hide();
			$("#alertModalTriggerButton").hide();
			
			$('#subheader').css("display","none");		//if logged in as anonymous then don't display subheader, else show the subheader
		
			$('#error_row').hide();
		}
		
		
		$("#loginform").submit(function(event){
			event.preventDefault();
			
			var error_row = document.getElementById("error_row");
			error_row.innerHTML = '';
			$('#error_row').css("display", "none");						//just to hide the error on re-submission of the form
			
			//get information filled in the form
			
			loginemail = $("#email").val();
			loginpassword = $("#password").val();
			signupstatus="email_activated";
			
			loginDbCreate();
		
		});
        
        function loginDbCreate(){
            loginpassword = CryptoJS.MD5(loginpassword);
            loginpassword = loginpassword.toString();

            var req = {
                auth: loginpassword,
                token: loginemail,
                signUpStatus: signupstatus
            }

            loginSend(req);

        }

        function loginSend(req){	
            //alert("loginSend called");
            $.ajax({
                    url: '/flsv2/LoginUser',
                    type:'get',
                    data: {req: JSON.stringify(req)},
                    contentType:"application/json",
                    dataType: "json",

                    success: function(response) {

                        if(response.Code === "FLS_SUCCESS") {
                            //alert("Success");
                            obj = JSON.parse(response.Message);

                            loginSuccessful(obj);
                        }
                        else{
                            //alert("unsuccessful");
                            loginerrormsg = response.Message;
                            loginUnsuccessful(response.Message);	
                        }
                    },

                    error: function() {
                        var msg = "Not Working";
                        confirmationIndex(msg);
                    }
                });
        };

		//google login starts here--------------------------------------------------	
		
			function onSignIn(googleUser) {
			
				var profile = googleUser.getBasicProfile();
				loginpassword = profile.getId();
				loginemail =  profile.getEmail();
				signupstatus = "google";
				
				// The ID token you need to pass to your backend:
				//var id_token = googleUser.getAuthResponse().id_token;
				
				loginDbCreate();	//this function is in the script_admin_v2.js
			};
		
		//google login ends here---------------------------------------------
		
		
		//Facebook Login starts here---------------------------------------------
		
		function facebookSignIn() {
		
		    reasonforLogIn = "Facebook";
            FB.login(function(response) {
				// handle the response
				
				FB.api('/me?fields=id,name,email,first_name,last_name,locale,gender', function(response) {
					loginpassword = response.id;
					loginemail =  response.email;
					signupstatus = "facebook";
					
					loginDbCreate();	//this function is in the script_admin_v2.js
				});
            }, {scope: 'email,public_profile,user_friends'});    
        }
		
		//Facebook Login ends here---------------------------------------------
		
		function loginSuccessful(obj){
			localStorage.setItem("userloggedin", obj.userId);				//set the "name" of the user who is loggedin
			//localStorage.setItem("userLocation", obj.location);
			localStorage.setItem("userloggedinName", obj.fullName);
			
			var msg = 1;
			
			
			if(reasonforLogIn == "Facebook"){
			reasonForAddFriend = "importFacebook";
			// retrieve the list of friends who have signed up using Facebook
				FB.api(
						'/me/friends', function (response) {
							if (response && !response.error) {
								addFriendAPICall = response.data.length;
								friends = response.data.length;
								for(var i =0;i<=response.data.length;i++){
									if (response.data.hasOwnProperty(i)) {
										var friend_name = response.data[i].name;
										var friend_id= response.data[i].id+"@fb";						
										addFriendSetValues(friend_name, '-', friend_id, loginemail);
										addFriendDbCreate();
									}
								}
							}
						}
					);
				}else{
				confirmationIndex(msg);
				}
		}
		
		function loginUnsuccessful(str){
			var msg = -1;
			
			confirmationIndex(msg);
			
		}
		
		function confirmationIndex(msg){			//called from script_admin_v2.js
			if(msg == -1){
				
				var heading = document.getElementById("myModalLabel");
				heading.innerHTML = "Login Failed";
				
				var div = document.getElementById("modalMsg");
				div.innerHTML = loginerrormsg;
			}else{
				
				var heading = document.getElementById("myModalLabel");
				heading.innerHTML = "Login Successful";
				
				var div = document.getElementById("modalMsg");
				
				if(reasonforLogIn == "Facebook"){
				div.innerHTML = "Welcome back to fRRndLease, You have "+friends+" Facebook friends in your fRRndLease friendlist";
				}else{
				div.innerHTML = "Welcome back to fRRndLease";
				}
			}
			
			$("#modalTriggerButton").click();
		}
        
        function addFriendSetValues(name, mobile, email, user){
            friendName = name;
            friendEmail = email;
            friendMobile = mobile;
            userId = user;

            if(friendName == '')
                friendName = null;
            if(friendEmail == '')
                friendEmail = null;
            if(friendMobile == '')
                friendMobile = 0;

        }

        function addFriendDbCreate(){

            var req = {
                id: friendEmail,
                fullName: friendName,
                mobile: friendMobile,
                userId: userId
            };

            addFriendSend(req);
        }

        function addFriendSend(req){
            $.ajax({
                url: '/flsv2/AddFriend',
                type:'get',
                data: {req: JSON.stringify(req)},
                contentType:"application/json",
                dataType: "json",

                success: function(response) {
                    //alert(response.Id+" "+response.Code+" "+response.Message);
                    //setPrevPage("myfriendslist.html");

                    if(reasonForAddFriend == "importGoogle"){
                        add_checked_friends_continued();
                    }else if(reasonForAddFriend == "importEmail"){
                        var header = "Congrats";
                        var msg = response.Message;
                        confirmationIndex(header, msg);
                    }else if(reasonForAddFriend == "importFacebook"){
                        var header = "Congrats";
                        addFriendAPICall--;
                        var msg = 1;
                        if(addFriendAPICall==0){
                            confirmationIndex(msg);
                        }
                    }else{
                        var header = "Friend Added";
                        var msg = "You can now lease items from "+friendName;
                        confirmationIndex(header, msg);	
                    }
                },

                error: function() {
                    var msg = "Not Working";
                    confirmationIndex(msg);
                }
            });

        }
		
		function redirectToPrevPage(){
			window.history.back();
		}
		
		function redirectToHomePage(){
			window.location.replace("index.html");
		}
	</script>
    
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/index.js"></script>
    <script src="js/tawk.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
