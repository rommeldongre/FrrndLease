<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="1074096639539-cect2rfj254j3q1i5fo7lmbfhm93jg34.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js"></script>		    									<!--for google signin-->
	<script src="js/md5.js"></script>																			<!--Password encryption-->
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>		<!--google geolocation api-->
	<script src="js/Facebook_api.js"></script>                                                     				 <!--for Facebook signin-->
	
	<title>Signup Page</title>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="js/jquery-1.11.3.min.js"></script>
    
	<!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/myindex.css" rel="stylesheet">
	<link href="css/login.css" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Happy+Monkey' rel='stylesheet' type='text/css'>
	<link href="css/bootstrap-social.css" rel="stylesheet">
	<link href="css/font-awesome.css" rel="stylesheet">
	
	<!--Loading Animation code CSS & JS Links  -->
	<link href="css/animation.css" type="text/css" rel="stylesheet">
	<script src="js/jquery.backstretch.js"></script>
	<script src="js/animation.js"></script>
	<!--Loading Animation code CSS & JS Links ends here  -->
  </head>
  
  <body onload="start()">
  <div id="loader">
	</div>
	<div id="main">	
		
        <!-- header starts here -->
		<nav class="navbar navbar-default" id="header">
			<div class="container-fluid">
				<div class="navbar-header">
					<a href="index.html" class="navbar-brand" id="icon"><b>frrndLease</b></a>
				</div>
			</div>
		</nav>
        <!-- header ends here -->
		
		<div class="container">
			
			<div class ="google">
                <div style="float:left;" class="g-signin2" data-onsuccess="onSignIn"></div>	                 <!--Google login button-->
			</div>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			
		    <!--FB signup button-->
			<div class="facebook" style="float:left;padding-left: 20px">
                <a class="btn btn-block btn-social btn-facebook" onclick="facebookSignIn();" style="width:220px;;height: 37px">
                <span class="fa fa-facebook"></span> Connect with Facebook
			</a>
			</div>
			
			<form class="form-signin" id="signupform">
				<!--<h2 class="form-signin-heading">Please sign up</h2>-->
				<div id="heading" class="form-signin-heading"><strong>Please sign up</strong></div>
				
				<span style="color:red">*</span><input type="email" id="email" class="form-control" placeholder="Email address" required autofocus><br />
				<span style="color:red">*</span><input type="password" id="password" class="form-control" placeholder="Password" required><br />
				<span style="color:red">*</span><input type="password" id="retypepassword" class="form-control" placeholder="Retype the Password" required><br />
				
				<input type="text" id="name" class="form-control" placeholder="Name"><br />
				<input type="text" id="mobile" class="form-control" placeholder="Mobile Number"><br />
				<input type="text" id="location" class="form-control" placeholder="Location"><br />
				
				
				<span id="newuser">
				Already have an account? <a href="mylogin.html" id="signup">Login</a>
				</span>
				<br /><br />
				<button class="btn btn-lg btn-primary btn-block" type="submit">Sign Up</button>	
		  </form>
		  <br />
			<!--Form ends here-->
			
			<!--Displaying error of the form-->
			<div id="error_row">
				<div class="col-md-12 col-sm-12 col-xs-12">
					<div class="alert alert-danger fade in" id="errormsg">
						<a href="#" class="close" data-dismiss="alert">&times;</a>
						<strong>Error!</strong> 
					</div>
				</div>
			</div>
		</div> <!-- /container -->
		
		
		<!-- Button trigger Alert Modal -->
		<button id="alertModalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myAlertModal" data-backdrop="static" data-keyboard="false">
		  Launch demo modal
		</button>

		<!-- Alert Modal -->
		<div class="modal fade" id="myAlertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<!--<h4 class="modal-title" id="myModalLabel"></h4>-->
			  </div>
			  <div class="modal-body" id="alertModalMsg">
				
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="continueWork()">Yes</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
			  </div>
			</div>
		  </div>
		</div>
		
		<!-- Button trigger Confirmation Modal -->
		<button id="modalTriggerButton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal" data-backdrop="static" data-keyboard="false">
		  Launch demo modal
		</button>

		<!-- Confirmation Modal -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">
				
				</h4>
			  </div>
			  <div class="modal-body" id="modalMsg">
				
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" onclick="redirectToPrevPage()">Close</button>
			  </div>
			</div>
		  </div>
		</div>
     
	    <!--The tawk.to widget code will get populated here from file chatbox.html.-->
        <div id="tawk_widget"></div>
			
		<nav class="navbar navbar-default navbar-fixed-bottom">
			<div class="container-fluid">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbarBottom">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>                        
				</button>
				<div class="collapse navbar-collapse" id="myNavbarBottom">
					<ul class="nav navbar-nav navbar-center">
						<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-th-large"></span> About</a></li>
						<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-pencil"></span> Blog</a></li>
						<li><a href="myhowitworks.html"><span class="glyphicon glyphicon-road"></span> How It Works</a></li>
						<li><a href="mycredits.html"><span class="glyphicon glyphicon-certificate"></span> Credits</a></li>
						<li><a href="https://www.facebook.com/frrndlease"><span class="glyphicon glyphicon-earphone"></span> Contact</a></li>
						<li><a href="https://www.surveymonkey.com/r/Y9GSGLJ" target="_blank"><span class="glyphicon glyphicon-comment"></span><b style="color:blue;"> Survey</b></a></li>
					</ul>
				</div>
			</div>
		</nav>
		
	</div>
	
	<script type="text/javascript">
		var signupname, signupemail, signupmobile, signuplocation, signuppassword, signupretypepassword, signupstatus, latitude, longitude, coords, reasonforLogIn = '', friends;
        
        // variables for storing the location data
        var Address = '', Sublocality = '', Locality = '', Lat = 0.0, Lng = 0.0;
		
		function start(){
			$("#modalTriggerButton").hide();
			$("#alertModalTriggerButton").hide();
			
			$('#subheader').hide();		//if logged in as anonymous then don't display subheader, else show the subheader
			$('#error_row').hide();
			
			getLocation();				//to show default location of the user
		}
		
		$("#signupform").submit(function(event){
			event.preventDefault();						//stop page from reloading
			
			$('#error_row').hide();						//just to hide the error on re-submission of the form
			
			//get information filled in the form
			signupname = $("#name").val();
			signupemail = $("#email").val();
			signupmobile = $("#mobile").val();
			signuplocation = $("#location").val();
			signuppassword = $("#password").val();
			signupretypepassword = $("#retypepassword").val();
			signupstatus = "email_pending";
			
			if(signupname == '') name = null;
			if(signupmobile == '') mobile = null;
			if(signuplocation == '') location = null;
			
			
			if(signupmobile.length != 10){									//mobile number validation (10 digits and number)
				var errormsg = document.getElementById("errormsg");
				var span = document.createElement("span");
				span.innerHTML = "Must be a 10 digit number";
				errormsg.appendChild(span);
				
				$('#error_row').show();
				
				signupmobile = Number(signupmobile);
				if(isNaN(signupmobile)){
					var errormsg = document.getElementById("errormsg");
					var span = document.createElement("span");
					span.innerHTML = "Must be a number";
					errormsg.appendChild(span);
				
					$('#error_row').show();
				}
			}
			else if(signuppassword != signupretypepassword){			//if password and retypedpassword are different
			
				var errormsg = document.getElementById("errormsg");
				var span = document.createElement("span");
				span.innerHTML = "Different passwords entered";
				errormsg.appendChild(span);
				
				$('#error_row').show();		
			}
			else{									//signup successful	
				signUpDbCreate();	//this function is in the script_admin_v2.js
			}
		
		});
        
        function signUpDbCreate(){
            signuppassword = CryptoJS.MD5(signuppassword);
            signuppassword = signuppassword.toString();

            Address = '';
            Sublocality = '';
            Locality = '';
            Lat = 0.0;
            Lng = 0.0;

            signuplocation = $("#location").val();
            if(signuplocation != '')
                getLocationData(signuplocation);
            else
                sendAddData();
            
        }
        
        sendAddData = function(){
            var signupactivation = CryptoJS.MD5(signupemail);
            signupactivation = signupactivation.toString();
            
            var req = {
                userId: signupemail,
                fullName: signupname,
                mobile: signupmobile,
                location: signuplocation,
                auth: signuppassword,
                activation: signupactivation,
                status: signupstatus,
                address: Address,
                locality: Locality,
                sublocality: Sublocality,
                lat: Lat+"",
                lng: Lng+""
                }
            signUpSend(req);
        }
        
        getLocationData = function(location){
            $.ajax({
                url: 'https://maps.googleapis.com/maps/api/geocode/json',
                type: 'get',
                data: 'address='+location+"&key=AIzaSyAmvX5_FU3TIzFpzPYtwA6yfzSFiFlD_5g",
                success: function(response){
                    if(response.status == 'OK'){
                        Address = response.results[0].formatted_address;
                        response.results[0].address_components.forEach(function(component){
                            if(component.types[0] == 'sublocality_level_1')
                                Sublocality = component.long_name;
                            if(component.types[0] == 'locality')
                                Locality = component.long_name;
                        });
                        Lat = response.results[0].geometry.location.lat;
                        Lng = response.results[0].geometry.location.lng;

                    }
                    sendAddData();
                },
                error: function(){
                    console.log("not able to get location data");
                }
            });
        }

        function signUpSend(req){
            //alert(req.auth);			//password going well

            $.ajax({
                url: '/flsv2/SignUp',
                type:'get',
                data: {req: JSON.stringify(req)},
                contentType:"application/json",
                dataType: "json",

                success: function(response) {
                    //alert(response.Id+" "+response.Code+" "+response.Message);
					if(response.Code === "FLS_SUCCESS") {
                    signupContinued(response.Code);			//this function is in signup.html
					}else{
						confirmationIndex(response.Id);
					}
                },		
                error: function() {
                    var msg = "Not Working";
                    confirmationIndex(msg);
                }
            });
        }

		//google signup starts here--------------------------------------------------	
		function onSignIn(googleUser) {
		
			var profile = googleUser.getBasicProfile();
			signuppassword = profile.getId();
			signupname = profile.getName();
			signupemail =  profile.getEmail();
			signuplocation = "";
			signupmobile = "";
			signupstatus = "google";
			
			console.log("ID: " + profile.getId()); 
			console.log("Name: " + profile.getName());
			console.log("Image URL: " + profile.getImageUrl());
			console.log("Email: " + profile.getEmail());
			
			// The ID token you need to pass to your backend:
			//var id_token = googleUser.getAuthResponse().id_token;
			
			signUpDbCreate();	//this function is in the script_admin_v2.js
		};
		
		//google signup ends here---------------------------------------------
		
		
		// Facebook signup starts here----------------------------------------
		
		function facebookSignIn() {
		
		    reasonforLogIn = "Facebook";
            FB.login(function(response) {
				// handle the response
				
				FB.api('/me?fields=id,name,email,first_name,last_name,locale,gender', function(response) {
					signuppassword = response.id;
					signupname = response.name;
					signupemail =  response.email;
					signuplocation = "";
					signupmobile = "";
					signupstatus = "facebook";
					
					signUpDbCreate();	//this function is in the script_admin_v2.js
				});

            }, {scope: 'email,public_profile,user_friends'});            
        }
		
		
		// Facebook signup ends here----------------------------------------
		
		function signupContinued(msg){
			
			// I am using localStorage here in this file instead of the model file because multiple users will need to be logged in simultaneously at different devices
			if(msg != 200 && signupstatus !== "email_pending"){
				localStorage.setItem("userloggedin", signupemail);				//set the "name" of the user who is loggedin	
				localStorage.setItem("userLocation", $("#location").val());
			}
			
			if(reasonforLogIn == "Facebook"){
			reasonForAddFriend = "importFacebook";
			// retrieve the list of friends who have signed up using Facebook
				FB.api(
						'/me/friends', function (response) {
							if (response && !response.error) {
								addFriendAPICall = response.data.length;
								friends = response.data.length;
								for(var i =0;i<=response.data.length;i++){
									if (response.data.hasOwnProperty(i)) {
										var friend_name = response.data[i].name;
										var friend_id= response.data[i].id+"@fb";						
										addFriendSetValues(friend_name, '-', friend_id, signupemail);
										addFriendDbCreate();
									}
								}
							}
						}
					);
				}else{
				confirmationIndex(msg);
				}
		}
	
		function confirmationIndex(msg){			//called from script_admin_v2.js
			if(msg == 200){
				
				var heading = document.getElementById("myModalLabel");
				heading.innerHTML = "Signup Failed";
				
				var div = document.getElementById("modalMsg");
				div.innerHTML = "User Already Exists";
			}else{
				
				var heading = document.getElementById("myModalLabel");
				heading.innerHTML = "Signup Successful";
				
				var div = document.getElementById("modalMsg");
				
				if(reasonforLogIn == "Facebook"){
				div.innerHTML = "Welcome to fRRndLease, You have "+friends+" Facebook friends in your fRRndLease friendlist";
				}else{
					if(signupstatus == "email_pending")
						div.innerHTML = "Please check your email to click on the link to activate your account!!";
					else
						div.innerHTML = "Welcome to fRRndLease";
				}
			}
			
			$("#modalTriggerButton").click();
		}
		
		function redirectToPrevPage(){
			window.history.back();
		}
		
		function redirectToHomePage(){
			window.location.replace("index.html");
		}
		
		
		//to get current location of the user and show it in the location by default
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			} else { 
				console.log("Geolocation is not supported by this browser.");
			}
		}

		function showPosition(position) {
			console.log("Latitude: "+position.coords.latitude+" Longitude: "+position.coords.longitude);

			latitude = position.coords.latitude;
			longitude = position.coords.longitude;
			coords = new google.maps.LatLng(latitude, longitude);	
			
			var geocoder = new google.maps.Geocoder();
			var latLng = new google.maps.LatLng(latitude, longitude);
			geocoder.geocode( { 'latLng': latLng}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					console.log(results[4].formatted_address);
					$("#location").val(results[4].formatted_address);
				}else{
						console.log("Geocode was unsucessfull in detecting your current location");
					}
			});
		}
        
        function addFriendSetValues(name, mobile, email, user){
            friendName = name;
            friendEmail = email;
            friendMobile = mobile;
            userId = user;

            if(friendName == '')
                friendName = null;
            if(friendEmail == '')
                friendEmail = null;
            if(friendMobile == '')
                friendMobile = 0;

        }

        function addFriendDbCreate(){

            var req = {
                id: friendEmail,
                fullName: friendName,
                mobile: friendMobile,
                userId: userId
            };

            addFriendSend(req);
        }

        function addFriendSend(req){
            $.ajax({
                url: '/flsv2/AddFriend',
                type:'get',
                data: {req: JSON.stringify(req)},
                contentType:"application/json",
                dataType: "json",

                success: function(response) {
                    //alert(response.Id+" "+response.Code+" "+response.Message);
                    //setPrevPage("myfriendslist.html");

                    if(reasonForAddFriend == "importGoogle"){
                        add_checked_friends_continued();
                    }else if(reasonForAddFriend == "importEmail"){
                        var header = "Congrats";
                        var msg = response.Message;
                        confirmationIndex(header, msg);
                    }else if(reasonForAddFriend == "importFacebook"){
                        var header = "Congrats";
                        addFriendAPICall--;
                        var msg = 1;
                        if(addFriendAPICall==0){
                            confirmationIndex(msg);
                        }
                    }else{
                        var header = "Friend Added";
                        var msg = "You can now lease items from "+friendName;
                        confirmationIndex(header, msg);	
                    }
                },

                error: function() {
                    var msg = "Not Working";
                    confirmationIndex(msg);
                }
            });

        }
			
	</script>

	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/index.js"></script>
    <script src="js/tawk.js"></script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
